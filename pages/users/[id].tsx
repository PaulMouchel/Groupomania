import { NextPage } from "next"
import styles from '../../styles/pages/User.module.scss'
import Head from 'next/head'
import Image from 'next/image'
import UserActivities from "../../components/UserActivities"
import UserSettings from "../../components/UserSettings"
import { useRouter } from 'next/router'
import UserType from "../../types/User"
import api from '../../api/axios'
import Avatar from '@mui/material/Avatar'
import Typography from '@mui/material/Typography'
import TextField from '@mui/material/TextField'
import Button from '@mui/material/Button'
import { useState, useEffect, useRef } from 'react'

const User: NextPage = () => {
    const router = useRouter()
    const { query, isReady } = router
    const { id } = query
    const userId = Number(id)

    const [ tab, setTab ] = useState<Number>(0)
    const [ user , setUser ] = useState<UserType | null>(null)
    const [ currentUser , setCurrentUser ] = useState<UserType | null>(null)
    const [ isCurrentUser, setIsCurrentUser ] = useState<boolean>(false)
    const descriptionRef = useRef<HTMLInputElement>(null)

    useEffect(() => {
        const currentUserStr = localStorage.getItem("user")
        if (currentUserStr) {
            const currentUser = JSON.parse(currentUserStr)
            setCurrentUser(currentUser)
        } 
    }, [])

    useEffect(() => {
        if(!isReady) {
            return
        }
        const fetchUser = () => {
            api.get(`/users/${userId}`, {
                headers: {
                    "authorization": localStorage.getItem("token") || ""
                }
            })
            .then((response) => {
                setUser(response.data)
                if (descriptionRef && descriptionRef.current) {
                    descriptionRef.current.value = response.data.description
                }
                
            })
            .catch((error:unknown) => {
                console.log(error)
            })
        }
        fetchUser()
    }, [router])

    useEffect(() => {
        if (user && currentUser) {
            setIsCurrentUser(user.id === currentUser.id)
        } else {
            setIsCurrentUser(false)
        }
    }, [user, currentUser])

    const changeDescription = async (e:React.FormEvent) => {
        e.preventDefault()
        if (currentUser) {
            const userId = currentUser.id
            const description = descriptionRef?.current?.value
            if (description !== "") {
                console.log(description)
                const userUpdate = { description:description }
                try {
                    const response = await api.patch(`/users/${userId}`, userUpdate, {
                        headers: {
                            "authorization": localStorage.getItem("token") ||""
                        }
                    })
                    localStorage.setItem("user", JSON.stringify(response.data))
                } catch (error:unknown) {
                    if (typeof error === "string") {
                        console.log(`Error: ${error}`)
                    } else if (error instanceof Error) {
                        console.log(`Error: ${(error as Error).message}`)
                    }
                }
            }
        }
    }

    return (
        <div className={styles.container}>
            <Head>
                <title>Create Next App</title>
                <meta name="description" content="Generated by create next app" />
                <link rel="icon" href="/favicon.ico" />
            </Head>

            <main className={styles.main}>
                <div className={styles.main__content}>
                    <div className={styles.header}>
                        <div className={styles.userpic}>
                            <Avatar alt={user ? user.name : "user pic"} src={user ? user.imageUrl : ""} sx={{ width: 250, height: 250 }} />
                        </div>
                        <span className={styles.username}>{user && user.name}</span>
                    </div>
                    { user && 
                        <>
                            <div className={styles.description}>
                                { isCurrentUser ? 
                                    <form onSubmit={(e:React.FormEvent) => changeDescription(e)}>
                                        <TextField
                                            id="description"
                                            label="Description"
                                            placeholder="Un mot sur vous ?"
                                            multiline
                                            variant="standard"
                                            fullWidth
                                            inputRef={descriptionRef}
                                        />
                                        <div className={styles.actions}>
                                            <Button variant="contained" type="submit" >Modifier</Button>
                                        </div>
                                    </form>
                                    :
                                    <Typography>{user.description}</Typography>
                                }
                            </div>
                            <div className={styles.tabs}>
                                <div className={`${styles.tab} ${tab === 0 && styles.active}`} onClick={() => setTab(0)}>Activité</div>
                                <div className={`${styles.tab} ${tab === 1 && styles.active}`} onClick={() => setTab(1)}>Paramètres</div>
                            </div>
                    
                            <div className={styles['tab-content']}>
                                { tab === 0 && <UserActivities user={user}/> }
                                { tab === 0 && <UserSettings/> }
                            </div>
                        </>
                    }
                </div>
            </main>


        </div>
    )
}
  
export default User
  